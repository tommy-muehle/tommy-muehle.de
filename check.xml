<?xml version="1.0" encoding="UTF-8"?>
<project name="check-tommy-muehle_de" default="build" basedir=".">

    <!-- Properties -->
    <property file="${basedir}/build.properties" />
    <property name="phpcs" value="${basedir}/bin/phpcs" />
    <property name="phpunit" value="${basedir}/bin/phpunit" />
    <property name="phpcpd" value="${basedir}/bin/phpcpd" />
    <!-- end -->

    <target name="build" depends="init, vendors, lint, phpunit, phpcpd" />

    <target name="init" description="Initialize something">

        <echo>Do composer self-update</echo>
        <exec dir="${basedir}" executable="${php}" failonerror="true">
            <arg value="composer.phar" />
            <arg value="self-update"/>
        </exec>

        <mkdir dir="${basedir}/build" />
        <mkdir dir="${basedir}/build/logs" />

    </target>

    <target name="vendors" description="Make composer update">
        <echo>Do composer update</echo>
        <exec dir="${basedir}" executable="${php}" failonerror="true">
            <arg value="composer.phar" />
            <arg value="update"/>
        </exec>
    </target>

    <target name="lint" depends="vendors" description="Perform syntax check of sourcecode files">
        <apply executable="${php}" failonerror="true">
            <arg value="-l" />
            <fileset dir="${basedir}/src">
                <include name="**/*.php" />
                <modified />
            </fileset>
        </apply>
    </target>

    <target name="phpunit" depends="vendors" description="Execute phpunit tests">
        <exec dir="${basedir}" executable="${php}" failonerror="true">
            <arg value="${phpunit}" />
            <arg value="--verbose" />
            <arg value="--debug" />
            <arg value="--log-junit" />
            <arg value="${basedir}/build/logs/phpunit.xml" />
        </exec>
    </target>

    <target name="phpcpd" description="Find duplicate code using PHPCPD">
        <exec executable="${phpcpd}">
            <arg line="--exclude Tests --log-pmd ${basedir}/build/logs/pmd-cpd.xml"/>
            <arg path="${basedir}/src"/>
        </exec>
    </target>

</project>