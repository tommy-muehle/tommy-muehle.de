<project default="build" basedir="../">

    <tstamp>
        <format property="date" pattern="Y-m-d-HH_mm_ss"/>
    </tstamp>

    <target name="build" depends="vendors, package" />

    <target name="vendors">
        <exec dir="${basedir}/website" executable="php" failonerror="true">
            <arg value="composer.phar" />
            <arg value="update" />
            <arg value="--no-dev" />
            <arg value="--optimize-autoloader" />
        </exec>
    </target>

    <target name="package" description="Start fpm to build the DEB package.">
        <exec executable="fpm">

            <!-- target os -->
            <arg value="--rpm-os"/>
            <arg value="linux"/>

            <!-- architecture (x86_64, noarch etc.) -->
            <arg value="-a"/>
            <arg value="all"/>

            <!-- source -->
            <arg value="-s"/>
            <arg value="dir"/>

            <!-- type of package -->
            <arg value="-t"/>
            <arg value="deb"/>

            <!-- name of package -->
            <arg value="-n"/>
            <arg value="tommy-muehle_de"/>

            <!-- force overwriting -->
            <arg value="--force"/>

            <!-- path on target-system -->
            <arg value="--prefix=/var/www/tommy-muehle_de/releases/${date}"/>

            <!-- excludes -->
            <arg value="-x"/>
            <arg value="**/.git*"/>
            <arg value="-x"/>
            <arg value=".git*"/>
            <arg value="-x"/>
            <arg value="**/logs/**"/>
            <arg value="-x"/>
            <arg value="**/bin/**"/>
            <arg value="-x"/>
            <arg value="**/cache/**"/>

            <!-- version -->
            <arg value="--version"/>
            <arg value="1.1"/> <!-- Project version -->

            <!-- package build path -->
            <arg value="-p"/>
            <arg value="${basedir}/build/"/>

            <!-- user things -->
            <arg value="--deb-user"/>
            <arg value="web"/>
            <arg value="--deb-group"/>
            <arg value="www-data"/>

            <!-- depends -->
            <arg value="-d"/>
            <arg value="php5"/>

            <!-- script for doing some tasks on target machine -->
            <arg value="--after-install"/>
            <arg value="${basedir}/build/after-install.sh"/>

            <!-- share variables to scripts like after_install -->
            <arg value="--template-scripts"/>
            <arg value="--template-value"/>
            <arg value="release=${date}"/>

            <!-- Path to the source-files
                 This path are combined with prefix (see above).
             -->
            <arg value="website"/>
        </exec>
    </target>
</project>
