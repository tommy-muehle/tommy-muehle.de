<?xml version="1.0" encoding="UTF-8"?>
<project name="check-tommy-muehle_de" default="build" basedir=".">

    <!-- Properties -->
    <property file="${basedir}/build.properties" />
    <!-- end -->

    <target name="build" depends="init, vendors, deploy" />

    <target name="init" description="Initialize something">

        <echo>Do composer self-update</echo>
        <exec dir="${basedir}" executable="${php}" failonerror="true">
            <arg value="composer.phar" />
            <arg value="self-update"/>
        </exec>

    </target>

    <target name="vendors" description="Make composer update">

        <echo>Do composer update</echo>
        <exec dir="${basedir}" executable="${php}" failonerror="true">
            <arg value="composer.phar" />
            <arg value="update"/>
            <arg value="--no-dev" />
        </exec>

    </target>

    <target name="deploy" depends="vendors" description="Transfer data to target system">

        <scp file="${basedir}/cli-config.php" todir="${remote_user}@${remote_host}:${remote_path}"
             keyfile="${remote_key}" failonerror="true" />

        <scp todir="${remote_user}@${remote_host}:${remote_path}" keyfile="${remote_key}" failonerror="true">
            <fileset dir="${basedir}">
                <include name="app/**" />
                <exclude name="app/cache/**" />
                <exclude name="app/logs/**" />
                <include name="src/**" />
                <include name="resources/**" />
                <include name="vendor/**" />
                <include name="web/**" />
            </fileset>
        </scp>

        <echo>Update orm scheme</echo>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="${remote_php} ${remote_path}/cli-config.php orm:schema-tool:update --force" />

        <echo>Load fixtures</echo>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="${remote_php} ${remote_path}/cli-config.php dbal:import ${basedir}/resources/fixtures/categories.sql" />
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="${remote_php} ${remote_path}/cli-config.php dbal:import ${basedir}/resources/fixtures/tags.sql" />

        <echo>Clear app cache</echo>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="rm -Rf ${remote_path}/app/cache/*" />

    </target>

</project>