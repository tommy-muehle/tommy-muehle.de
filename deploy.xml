<?xml version="1.0" encoding="UTF-8"?>
<project name="check-tommy-muehle_de" default="build" basedir=".">

    <!-- Properties -->
    <property file="${basedir}/build.properties" />
    <!-- end -->

    <target name="build" depends="init, vendors, deploy" />

    <target name="init" description="Initialize something">

        <echo>Do composer self-update</echo>
        <exec dir="${basedir}" executable="${php}" failonerror="true">
            <arg value="composer.phar" />
            <arg value="self-update"/>
        </exec>

    </target>

    <target name="vendors" description="Make composer update">

        <echo>Do composer update</echo>
        <exec dir="${basedir}" executable="${php}" failonerror="true">
            <arg value="composer.phar" />
            <arg value="update"/>
            <arg value="--no-dev" />
        </exec>

    </target>

    <target name="deploy" depends="vendors" description="Transfer data to target system">

        <tar basedir="${basedir}" destfile="release.tar.gz" compression="gzip">
            <include name="cli-config.php" />
            <include name="app/**" />
            <exclude name="app/cache/**" />
            <exclude name="app/logs/**" />
            <include name="src/**" />
            <include name="resources/**" />
            <include name="vendor/**" />
            <include name="web/**" />
        </tar>

        <tstamp>
            <format property="timestamp" pattern="yyyyMMdd_HHmmss"/>
        </tstamp>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase=""
                 username="${remote_user}" command="mkdir -p ${remote_path}/releases/${timestamp}" />

        <scp file="${basedir}/release.tar.gz" todir="${remote_user}@${remote_host}:${remote_path}"
             keyfile="${remote_key}" failonerror="true" />

        <echo>Untar archive in release folder</echo>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="tar -xzf ${remote_path}/releases/${timestamp}/release.tar.gz -C ${remote_path}/releases/${timestamp}"/>

        <echo>Set symlink to new release</echo>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="ln -snf ${remote_path}/releases/${timestamp} ${remote_path}/current"/>

        <echo>Update orm scheme</echo>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="${remote_php} ${remote_path}/cli-config.php orm:schema-tool:update --force" />

        <echo>Load fixtures</echo>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="${remote_php} ${remote_path}/cli-config.php dbal:import ${basedir}/resources/fixtures/categories.sql" />
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="${remote_php} ${remote_path}/cli-config.php dbal:import ${basedir}/resources/fixtures/tags.sql" />

        <echo>Clear app cache</echo>
        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="rm -Rf ${remote_path}/app/cache/*" />

        <sshexec port="${remote_port}" host="${remote_host}" keyfile="${remote_key}" passphrase="" username="${remote_user}"
                 command="rm -f ${remote_path}/releases/${timestamp}/release.tar.gz" />

        <delete file="${basedir}/release.tar.gz" />

    </target>

</project>